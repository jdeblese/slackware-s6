#!/bin/execlineb -S0

# This is the shutdown script, running as process 1.

# Set linefeed mode to avoid staircase effect.
foreground { /bin/stty onlcr }

# Make sure we have no open handle to anywhere else
# than /dev/console
cd /
fdclose 0
redirfd -w 1 /dev/console
fdmove -c 2 1

# Start a sync in the background as the shutdown gets going
background { /bin/sync }

foreground { /etc/s6-init/cleanup }

foreground { echo "Syncing disks." }
foreground { /bin/sync } # yes, it helps.
foreground { echo "Unmounting disks." }

# Log to WTMP
foreground { echo "Log ${1} to wtmp." }
foreground { /sbin/${1} -w }

# Clear locks
foreground {
  if { test -d /var/lock/subsys }
  /bin/sh -c "/usr/bin/rm -f /var/lock/subsys/*" }

# Turnoff swap
foreground { echo "Turning off swap." }
foreground { /sbin/swapoff -a }
foreground { /bin/sync }

# Unmount filesystems
foreground { echo "Unmounting local file systems." }
foreground { /bin/umount -v -a -t no,proc,sysfs,tmpfs }

foreground { echo "Remounting root filesystem read-only." }
foreground { /bin/mount -v -n -o remount,ro / }

# FIXME cryptsetup?

# Deactivate LVM volume groups:
foreground {
  if { test -r /etc/lvmtab -o -d /etc/lvm/backup }
  foreground { echo "Deactivating LVM volume groups:" }
  /sbin/vgchange -an --ignorelockingfailure }

# This never hurts again (especially since root-on-LVM always fails
# to deactivate the / logical volume...  but at least it was
# remounted as read-only first)
foreground { /bin/sync }

# sleep 3 fixes problems with some hard drives that don't
# otherwise finish syncing before reboot or poweroff
foreground { /bin/sleep 3 }

# This is to ensure all processes have completed on SMP machines:
foreground { echo "Waiting for child processes to exit." }
wait { }

# FIXME genpowered?

# Reboot, halt or poweroff the machine, depending on the parameter
# that was given to the script.
foreground { echo "\nPerforming "${1}"." }
${1} -df
